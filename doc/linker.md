# 소스 코드와 문서를 서로 연결하는 방법

## 기본적인 방법

```ts
file:///d:/Samuel/.../doc/sample.md    절대 경로 가능(ctrl+click(O), follow link(O))
file:///./../doc/sample.md             상대 경로 가능(ctrl+click(O), follow link(X))
file:///../doc/sample.md               안됨(현재 경로인 ./ 필요)
file:///sample.md                      안됨(현재 경로인 ./ 필요)

file:///./sample?#L10-L20              범위 지정(ctrl+click(O)), follow link(X) 해당 범위로 이동(X))
```

이 방법은 VS Code가 기본적으로 지원하기 때문에 어떤 경우라도 사용할 수 있는 장점이 있지만 여러가지 불편함이 있다.

- VS Code가 기본으로 지원
- 상대 경로, 절대 경로 모두 가능
- 반드시 `file:///` 으로 시작하여야 한다.
- ctrl + click으로 이동
- ctrl + click이 아니라 hover시 표시되는 Follow Link 를 클릭하면 상대 경로는 인식하지 못하고 에러...
- 범위 지정은 에러가 되진 않지만 범위로 이동하지는 못함

정리하자면 VS Code에서 기본적으로 제공하는 `file:///`로 시작하는 링크는 절대 경로인 경우에는 ctrl+click, follow link 모두 가능하지만 `file:///./`로 시작하는 상대 경로인 경우에는 ctrl+click만 가능하다. workspace 경로와 범위로 이동하는 기능은 지원하지 않는다.

## 코드 프리즘이 지원하는 방법

```ts
[code](file:///d:/Samuel/...prism/Prism.ts)  절대 경로
[code](d:/Samuel/...prism/Prism.ts)          지원하지 않음
[code](./../src/code-prism/Prism.ts)         상대 경로
[code](/src/code-prism/Prism.ts)             root 경로
[code](src/code-prism/Prism.ts)              지원하지 않음
[docu](./sample.md)                          상대 경로
```

### 1. 마크다운 방식 지원

코드 프리즘은 마크다운의 링크와 동일한 방법으로 문서 연결을 지원한다.

코드 프리즘의 표현 방법이 마크다운과 동일하기 때문에 여러가지 기능들에 대해서 이것이 코드 프리즘에서 제공하는 기능인지 아니면 마크다운에서 제공하는 기능인지 혼란스러울 때가 많다. 그래서 코드 프리즘의 방식을 설명하기 전에 먼저 마크다운의 파일 링크 방식에 대해서 살펴보겠다.

마크다운에서 로컬 파일 패스를 지정하는 방법은 3가지가 있다.

- `file:///절대경로`
- `./상대경로`
- `/Workspace경로`

일단 마크다운은 패스에 공백이나 괄호등이 들어가면 경로로 인식하지 못한다. 그리고 workspace 경로는 반드시 `/`로 시작해야 한다는 점이 중요하다 아울러 마크다운 파일 링크는 범위로 바로 가는 기능은 없다.

그리고 마크다운 형태로 표시된다고 해서 즉 마크다운으로 랜더링된다고 해서 모두 마크다운의 링크기능을 지원하는 것은 아니다. 특히나 VS Code는 여러 곳에서 vscode.MarkdownString 객체를 사용하는데 이 개체에 적법한 링크가 포함되어져 있다고 반드시 링크가 정상적으로 처리될 것이라고 기대할 수 없다.

코드 프리즘의 경우 마크다운으로 랜더링되는 곳 중에서 링크를 지원해야 하는 곳은 hover tooltip의 경우와 comment controller의 입력창의 경우가 있는데 comment controller의 입력창에서 설정하는 링크는 `file:///절대경로` 만 인식하였다.

즉 마크다운에서 로컬 패스를 지정하는 방식은 마크다운 에디터 및 마크다운이 표시되는 곳에 따라서 조금씩 다를 수 있다

코드 프리즘은 마크다운과 동일하게 절대 경로, 상대 경로, workspace root 기준 경로를 지원하며 경로를 표시하는 방법도 마크다운과 동일하다.  
절대 경로는 `file:///`로 시작하며 상대 경로는 `./`로 시작하며 workspace root에서 시작하는 경로는 `/`을 사용해야 한다. 사실 코드 프리즘은 workspace 경로를 위해서 반드시 `/`로 시작해야 하는 제한을 둘 필요는 없었다. 하지만 이런 예외 사항이 꽤 혼란스러워서 마크다운과 통일시켰다.

일반적으로 절대 경로는 길고, 상대 경로는 변동성도 높고 복잡할 수 있기 때문에 workspace root 경로가 편하다. 하지만 동일한 폴더에 있는 다른 문서를 참조하는 경우는 상대 경로로 더 간단히 입력할 수 있다.

코드 프리즘은 임의의 문서에서 `[]()` 형태의 문자열을 인식하고 ()에 있는 다양한 패스를 모두 절대 경로로 변경해 주기 때문에 이런 처리가 가능한 것이다.

이때 코드 프리즘은 [] 안에만 링크 표시를 하고 () 안에는 링크 표시를 하지 않는다. 즉 [] 부분을 클릭해야만 이동할 수 있다. 하지만 두 곳 모두에서 hover tooltip은 동작한다. 이것을 언급하는 이유는 마크다운 텍스트 편집기에서 ()안의 부분이 링크 표시되어지는 것은 마크다운의 기능이라는 것을 강조하기 위해서이다.

VS Code가 기본 지원하는 Follow Link는 상대 경로를 인식하지 못하는 문제가 있었는데 코드 프리즘은 이 follow link도 정상 동작한다.

코드 프리즘에서 이것을 위해서 아무것도 한게 없는데도 정상 동작한다. 이유는 무엇일까?

`provideDocumentLinks` 함수는 `vscode.DocumentLink` 객체들을 리턴하는데 이 개체에는 `const link = new vscode.DocumentLink(range, vscode.Uri.file(path))`와 같이 링크될 Uri를 가지고 있다.

이 Uri는 `file:///`으로 시작하고 전체 경로이어야 하며 폴더 구분자로 반드시 `/`을 사용해야 하는 등의 제한이 있다.

follow link 자체의 툴팁을 보면 변환되거나 하지 않은 링크 문자열 그대로가 표시되는 것으로 봐서 아마도 기존의 Follow Link hover 기능은 이 uri로 링크 문자열을 그대로 전달하고 ctrl + click을 할 경우에만 이 정보를 내부적으로 계산해서 문서를 오픈하는 것 같다. 즉 uri를 나중에 계산하는 것이다.

하지만 다른 익스텐션은 나중에, 내부적으로 계산할 수 없기 때문에 미리 uri를 설정해야 하는데 그래서 follow link도 정상 동작하는 것으로 생각된다.

마크다운 형태로 되어져 있어 이해하기 용이하지만 이것은 md 파일에서 테스트하면 기존의 마크다운 링크기능이랑 혼동이 되기 때문에 텍스트 문서에서 테스트되어야 한다.

### 2. 특정 부분 명시 기능

깃헙에서는 소스 코드의 특정 부분과의 연결이 가능하게 다음과 같이 URI가 확장되었으나 아직 VS Code에서는 지원하지 않음(파일을 열 수 있지만 해당 위치로 이동해서 표시해 주지는 않는다)

```ts
// file:///./../readme.md?plain=1#L60-L61
```

깃헙의 방식은 github에서만 사용 가능하고 자동적으로 코드를 가져와서 표시하는 것은 동일한 레퍼지토리에서만 가능하다는 단점도 있다(다른 레퍼지토리에 대해 동일한 방법으로 링크를 걸어도 링크만 표시될 뿐 자동으로 코드를 표시해 주지는 않는다)

코드 프리즘은 깃헙과 동일한 방식으로 코드나 문서의 특정 부분을 명시할 수 있다.

```ts
[code](/src/code-prism/Prism.ts?#L50-L60)
[code](/src/code-prism/Prism.ts#L50-L60)
[code](/src/code-prism/Prism.ts#50-60)
```

이 기능은 이것을 파싱해서 fragment를 넘겨만 주면 vscode가 알아서 처리해 주었다. 즉 이미 기능이 있는데 file:/// 링크가 아직 적용되지 못한 것 같다.
위의 예에서와 같이 ? 은 사용할 수도 있고 사용하지 않아도 된다. 하지만 `Prism.ts#L50-60`은 정상적인 파일명이 될 수 있기 때문에 ? 을 사용하는 것이 더 좋다. 또한 line을 나타내는 L은 두 곳 다 사용할 수도 있지만 전혀 사용하지 않아도 된다.

### 3. hover tooltip

Code Prism은 `[]()`형식으로 되어진 텍스트를 만나면 링크로 인식하고 hover 툴팁도 제공한다.

툴팁은 링크되어진 파일이 markdown 파일이면 markdown 프리뷰 형태로 표시하고 그렇지 않은 파일들은 코드 형태로 10줄 정도 미리보기가 가능하다. 툴팁에는 open document 링크가 있어 이를 통해 해당 문서를 오픈할 수 있다. 이때에도 마크다운 문서는 side view로 preview로 표시되고 나머지는 직접 오픈된다.

### 정리

코드 프리즘은 임의의 문서에서 `[]()`형태로 되어진 문자열을 인식하게 되면 다음과 같은 기능을 지원한다.

- ctrl+click으로 해당 문서 오픈
- tooltip으로 해당 내용을 미리보기
- 미리보기 내에서 링크를 이용해 문서를 오픈

코드 프리즘이 프로그램으로 다양한 조건을 지원하기는 하지만 시스템 자체의 문제로 지원할 수 없는 것들도 있다.

우선 지원되는 것들을 살펴보면 (`[description](path)` 라고 되어진 경우)

1. path를 지정하는 여러가지 경우
   - path가 절대 경로인 경우(`file:///`로 시작하는 경우)
   - path가 상태 경로인 경우(`./`로 시작하는 경우)
   - path가 workspace root 경로인 경우(`/`로 시작하는 경우)
2. 위 각각의 path에 범위가 포함되어진 경우
3. description을 ctrl + click한 경우
4. path 자체를 ctrl + click한 경우

   path 자체를 ctrl + click한다는 의미는 그냥 텍스트 파일에 있는 path에 대한 적용과 동일한 의미이다. 그런데 이걸 언급하는 이유는 마크다운 텍스트 에디터 상태에서 ()안에 패스는 링크가 되어 있고 이것을 클릭할 수 있기 때문이다. 이것은 마크다운 자체가 지원하는 것으로 코드 프리즘과는 관련이 없다.

   그냥 텍스트에서는 `file:///`로 시작하지 않으면 링크의 대상 자체가 안되지만 md 파일 내에서는 더 다양한 path가 링크의 대상이 된다. 코드 프리즘이 설치되어져 있던 아니던 마크다운 텍스트 편집 상태에서는 () 안의 패스는 마크다운이 처리하기 때문에 `/`로 시작하지 않는 패스는 에러가 된다. 또한 이 경우 () 패스는 범위 이동도 되지 않는다.

5. follow link click
   follow link는 코드 프리즘이 표시하는 것은 아니지만 모두 지원된다.
6. hover 표시 상태
   path만 정상적이면 hover tooltip에 미리보기와 open document link가 정상적으로 표시된다.
   이 부분은 조금 논란의 여지가 있다. 동일한 내용이 툴팁으로 표시되어도 이것이 md 파일상에서 표시되는 것인지 아니면 텍스트 파일상에서 표시되는 것인지에 따라서 표시되는 색상의 차이가 있다.
7. hover tooltip 내에서 클릭 하는 경우
8. markdown 파일이 랜더링되었을 때의 경우

| link                                      | 코드                                | 특징      |
| ----------------------------------------- | ----------------------------------- | --------- |
| [code](src/code-prism/Prism.ts)           | `src/code-prism/Prism.ts`           | 지원 안됨 |
| [code](/src/code-prism/Prism.ts)          | `/src/code-prism/Prism.ts`          | 루트 경로 |
| [code](./../src/code-prism/Prism.ts)      | `./../src/code-prism/Prism.ts`      | 상대 경로 |
| [code](/src/code-prism/Prism.ts?#L50-L60) | `/src/code-prism/Prism.ts?#L50-L60` | 범위 지정 |
| [code](/src/code-prism/Prism.ts#L50-L60)  | `/src/code-prism/Prism.ts#L50-L60`  | 범위 지정 |
| [code](/src/code-prism/Prism.ts#50-60)    | `/src/code-prism/Prism.ts#50-60`    | 범위 지정 |
| [docu](./sample.md)                       | `./sample.md`                       | 상대 경로 |

## 개선 사항

소스 코드와 문서를 연결하는 방법은 다음과 같이 개선되어야 한다.

- 문서와 코드의 연결이 상호 참조가 되어야 한다.
- Preview 기능 및 표현 방법의 개선이 필요하다.
- 입력 방법의 개선

### 코드와 문서의 상호 참조

범위를 명시하는 경우에는 더더욱 그렇지만 소스에서 문서를 링크하면 문서에도 그 부분이 소스의 어디에서 링크되어져 있는지가 자동으로 추가되어야 한다. 물론 이렇게 할 것인지의 여부는 선택할 수 있어야 한다.

### Preview 기능 및 표현 방법의 개선

프리뷰를 포함해서 궁극적으로는 주석의 내용을 아름답게 표현할 필요가 있다.

### 입력 방법의 개선

연결을 할 때에도 불편한 점이 많다.
파일의 링크를 수동으로 입력하는 것이 매우 불편하다. 이를 개선해서 파일을 제안하는 방식으로 개선해야 한다.

입력 방법을 개선하는데 있어 가장 큰 영향을 미치는 것은 URI scheme을 제거하는 것이라고 생각된다. 마크다운 링크 방법을 사용하는 것으로 한다.

아울러 문서들이 특정 폴더에 있는 것으로 정하는 것도 나쁘지 않다고 생각된다. 즉 doc 폴더 같은 것을 상정하는 것이다. 그러면 파일명만 가지고 문서를 지정할 수 있어 매우 편해진다. 물론 소스코드도 src를 디폴트로 상정할 수 있다. 이들은 설정으로 변경할 수 있는데 설정 자체가 귀찮을 수 있기 때문에 이점은 고민해 볼 필요가 있다.
